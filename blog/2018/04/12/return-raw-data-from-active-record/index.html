<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>Writing Super Fast Queries in Rails &#183; Cassidy Scheffer</title>
<link rel=stylesheet href=/css/style.css>
<link rel=stylesheet href=/css/fonts.css>
<link rel=icon href=favicon.ico>
<link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16.png>
<link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png>
<link href rel=alternate type=application/rss+xml title="Cassidy Scheffer">
</head>
<body>
<nav class=nav>
<div class=nav-container>
<a href=/>
<h2 class=nav-title>Cassidy Scheffer</h2>
</a>
<ul>
<li>
<a href=/blog/>
<span>Posts</span>
</a>
</li>
<li>
<a href=https://github.com/cassidycodes>
<span>GitHub</span>
</a>
</li>
<li>
<a href=https://www.linkedin.com/in/cassidyscheffer/>
<span>LinkedIn</span>
</a>
</li>
</ul>
</div>
</nav>
<main>
<div class=post>
<div class=post-info>
<span>Written by</span>
Cassidy Scheffer
<br>
<span>on&nbsp;</span><time datetime="2018-04-12 00:00:00 +0000 UTC">April 12, 2018</time>
</div>
<h1 class=post-title>Writing Super Fast Queries in Rails</h1>
<div class=post-line></div>
<p>At work this week I had to speed up a background job that was clogging up our queue. This job aggregates data on records and posts to our Elastic Search index. It was suffering from all kinds of extra database calls. I had lots of fun working on this query! It’s so satisfying to make things fast.</p>
<p>Here’s a bit of what I learned about building SQL queries that can get tough with a typical ActiveRecord object.</p>
<h2 id=a-bit-about-the-data>A bit about the data</h2>
<p>Let’s imaging we have a blog that has many users. Each user has many posts, and posts have many comments. Your database might look like this:</p>
<p><strong>users</strong></p>
<pre tabindex=0><code>id | name
---|------------------
1  | Sonja Sis
2  | Nicol Hollinghead
3  | Edison Huseman
</code></pre><p><strong>posts</strong></p>
<p>id|title|body|user_id
1 | I love dogs | Dogs are great. | 1
2 | I love cats | Cats are better than dogs. | 2
3 | I love both dogs and cats | Pets are fun. | 3</p>
<p><strong>comments</strong></p>
<pre tabindex=0><code>id | body          | user_id | post_id
---|---------------|---------|--------
1  | Me too!       | 3       | 2
2  | They are not! | 1       | 2
</code></pre><p>Now lets say we want to know how many comments each post has received in the last 90 days, 30 days, and 15 days. We&rsquo;re looking for a data structure like this in the end:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>{ <span style=color:#ae81ff>1</span> <span style=color:#f92672>=&gt;</span> { <span style=color:#e6db74>ninety_days</span>:  <span style=color:#ae81ff>190</span>,
         <span style=color:#e6db74>thirty_days</span>:  <span style=color:#ae81ff>67</span>,
         <span style=color:#e6db74>fifteen_days</span>: <span style=color:#ae81ff>14</span> },
  <span style=color:#ae81ff>2</span> <span style=color:#f92672>=&gt;</span> { <span style=color:#e6db74>ninety_days</span>:  <span style=color:#ae81ff>583</span>,
         <span style=color:#e6db74>thirty_days</span>:  <span style=color:#ae81ff>392</span>,
         <span style=color:#e6db74>fifteen_days</span>: <span style=color:#ae81ff>83</span> } }
</code></pre></div><p>We could try something like this:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Post</span> <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>ActiveRecord</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Base</span>
  scope <span style=color:#e6db74>:between</span>, (range)<span style=color:#f92672>-&gt;</span> { where(<span style=color:#e6db74>created_at</span>: range }
<span style=color:#66d9ef>end</span>

<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyPostSummary</span>
  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>.</span><span style=color:#a6e22e>summarize</span>
    <span style=color:#66d9ef>Post</span><span style=color:#f92672>.</span>find_each<span style=color:#f92672>.</span>with_object({}) <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>post, h<span style=color:#f92672>|</span>
      h<span style=color:#f92672>[</span><span style=color:#e6db74>:post_id</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> {}
      h<span style=color:#f92672>[</span>post<span style=color:#f92672>.</span>id<span style=color:#f92672>][</span><span style=color:#e6db74>:ninety_days</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span>
        post<span style=color:#f92672>.</span>comments<span style=color:#f92672>.</span>between(<span style=color:#ae81ff>90</span><span style=color:#f92672>.</span>days<span style=color:#f92672>.</span>ago<span style=color:#f92672>..</span><span style=color:#ae81ff>0</span><span style=color:#f92672>.</span>days<span style=color:#f92672>.</span>ago)<span style=color:#f92672>.</span>count
      h<span style=color:#f92672>[</span>post<span style=color:#f92672>.</span>id<span style=color:#f92672>][</span><span style=color:#e6db74>:thirty_days</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span>
        post<span style=color:#f92672>.</span>comments<span style=color:#f92672>.</span>between(<span style=color:#ae81ff>30</span><span style=color:#f92672>.</span>days<span style=color:#f92672>.</span>ago<span style=color:#f92672>..</span><span style=color:#ae81ff>0</span><span style=color:#f92672>.</span>days<span style=color:#f92672>.</span>ago)<span style=color:#f92672>.</span>count
      h<span style=color:#f92672>[</span><span style=color:#e6db74>:post_id</span><span style=color:#f92672>][</span><span style=color:#e6db74>:fifteen_days</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span>
        post<span style=color:#f92672>.</span>comments<span style=color:#f92672>.</span>between(<span style=color:#ae81ff>15</span><span style=color:#f92672>.</span>days<span style=color:#f92672>.</span>ago<span style=color:#f92672>..</span><span style=color:#ae81ff>0</span><span style=color:#f92672>.</span>days<span style=color:#f92672>.</span>ago)<span style=color:#f92672>.</span>count
  <span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span>

<span style=color:#66d9ef>MyPostSummary</span><span style=color:#f92672>.</span>summarize

<span style=color:#75715e># { 1 =&gt; { ninety_days: 190,</span>
<span style=color:#75715e>#         thirty_days:  67,</span>
<span style=color:#75715e>#         fifteen_days: 14 },</span>
<span style=color:#75715e>#  2 =&gt; { ninety_days:  583,</span>
<span style=color:#75715e>#         thirty_days:  392,</span>
<span style=color:#75715e>#         fifteen_days: 83 } }</span>
</code></pre></div><p>Pretty repetitive, right? If we’re building a summary of all of our the posts in our blog, we&rsquo;re going to be doing a lot of unnecessary counting!</p>
<h2 id=using-select>Using <code>select</code></h2>
<p>When I first tackled this problem, I thought, “Hmmm, maybe I can use ActiveRecord&rsquo;s <code>select</code> to select a count for each period.” This does wonders for saving database queries! I’ll leave out the rest of the class here for brevity. Here’s what that query looks like:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#75715e># Use SQL to count the comments for each post.</span>
select <span style=color:#f92672>=</span> <span style=color:#f92672>&lt;&lt;~</span><span style=color:#66d9ef>SQL</span>
           posts<span style=color:#f92672>.</span>id,
           <span style=color:#66d9ef>Count</span>(<span style=color:#66d9ef>IF</span>(comments<span style=color:#f92672>.</span>created_at <span style=color:#f92672>&gt;</span>
                    <span style=color:#66d9ef>DATE_SUB</span>(<span style=color:#66d9ef>CURRENT_TIMESTAMP</span>, <span style=color:#ae81ff>90</span> <span style=color:#66d9ef>DAY</span>),
                    comments<span style=color:#f92672>.</span>id,
                    <span style=color:#66d9ef>NULL</span>)) <span style=color:#66d9ef>AS</span> ninety_days,
           <span style=color:#66d9ef>Count</span>(<span style=color:#66d9ef>IF</span>(<span style=color:#66d9ef>DATE_SUB</span>(<span style=color:#66d9ef>CURRENT_TIMESTAMP</span>, <span style=color:#ae81ff>30</span> <span style=color:#66d9ef>DAY</span>),
                    comments<span style=color:#f92672>.</span>id,
                    <span style=color:#66d9ef>NULL</span>)) <span style=color:#66d9ef>AS</span> thirty_days,
           <span style=color:#66d9ef>Count</span>(<span style=color:#66d9ef>IF</span>(<span style=color:#66d9ef>DATE_SUB</span>(<span style=color:#66d9ef>CURRENT_TIMESTAMP</span>, <span style=color:#ae81ff>15</span> <span style=color:#66d9ef>DAY</span>),
                    comments<span style=color:#f92672>.</span>id,
                    <span style=color:#66d9ef>NULL</span>)) <span style=color:#66d9ef>AS</span> fifteen_days
         <span style=color:#66d9ef>SQL</span>
</code></pre></div><p>We need a <code>LEFT OUTER JOIN</code> here because we want to be sure we get posts back even if they have 0 comments.</p>
<p>Also note the <code>group</code> here. Without this, we&rsquo;d get 1 post record back for each comment and we&rsquo;d end up with duplicates because posts have many comments!</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>posts <span style=color:#f92672>=</span> <span style=color:#66d9ef>Post</span><span style=color:#f92672>.</span>left_outer_joins(<span style=color:#e6db74>:comments</span>)
            <span style=color:#f92672>.</span>select(select)
            <span style=color:#f92672>.</span>group(<span style=color:#e6db74>&#34;posts.id&#34;</span>)

posts<span style=color:#f92672>.</span>find_each<span style=color:#f92672>.</span>with_object({}) <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>post, h<span style=color:#f92672>|</span>
  h<span style=color:#f92672>[</span><span style=color:#e6db74>:post_id</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> {}
  h<span style=color:#f92672>[</span>post<span style=color:#f92672>.</span>id<span style=color:#f92672>][</span><span style=color:#e6db74>:ninety_days</span><span style=color:#f92672>]</span>  <span style=color:#f92672>=</span> post<span style=color:#f92672>.</span>ninety_days
  h<span style=color:#f92672>[</span>post<span style=color:#f92672>.</span>id<span style=color:#f92672>][</span><span style=color:#e6db74>:thirty_days</span><span style=color:#f92672>]</span>  <span style=color:#f92672>=</span> post<span style=color:#f92672>.</span>thirty_days
  h<span style=color:#f92672>[</span>post<span style=color:#f92672>.</span>id<span style=color:#f92672>][</span><span style=color:#e6db74>:fifteen_days</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> post<span style=color:#f92672>.</span>fifteen_days
<span style=color:#66d9ef>end</span>
</code></pre></div><p>Ok, great! We’ve solved the problem of counting the going back to the database to count the comments. Now we just do one query that returns a count for us.</p>
<p>Did you know that when you add <code>SELECT … AS my_select</code>, ActiveRecord will add a method for that attribute to the object returned? That’s why <code>post.ninety_days</code> works in the code above. I thought that was pretty handy.</p>
<p>I’m still not comfortable with this end result though. We’re loading records into ActiveRecord when all we need from them is the count data and the post id.</p>
<h2 id=exec_query-to-the-rescue><code>exec_query</code> to the rescue!</h2>
<p><code>exec_query</code> returns a hash of the column names and values you asked for. This lets you skip active record entirely!</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>query <span style=color:#f92672>=</span> <span style=color:#66d9ef>Post</span><span style=color:#f92672>.</span>left_outer_joins(<span style=color:#e6db74>:comments</span>)
            <span style=color:#f92672>.</span>select(select)
            <span style=color:#f92672>.</span>group(<span style=color:#e6db74>&#34;posts.id&#34;</span>)
            <span style=color:#f92672>.</span>to_sql
result <span style=color:#f92672>=</span> <span style=color:#66d9ef>Post</span><span style=color:#f92672>.</span>connection<span style=color:#f92672>.</span>exec_query(query)
<span style=color:#75715e># =&gt; [{ &#34;id&#34;           =&gt; 1,</span>
<span style=color:#75715e>#       &#34;ninety_days&#34;  =&gt; 190,</span>
<span style=color:#75715e>#       &#34;thirty_days&#34;  =&gt; 67,</span>
<span style=color:#75715e>#       &#34;fifteen_days&#34; =&gt; 14 }...]</span>

result<span style=color:#f92672>.</span>map!(<span style=color:#f92672>&amp;</span>symbolize_keys!)<span style=color:#f92672>.</span>group_by(<span style=color:#f92672>&amp;</span><span style=color:#e6db74>:id</span>)
<span style=color:#75715e># =&gt;</span>
<span style=color:#75715e># { 1 =&gt; { ninety_days: 190,</span>
<span style=color:#75715e>#         thirty_days:  67,</span>
<span style=color:#75715e>#         fifteen_days: 14 },</span>
<span style=color:#75715e>#  2 =&gt; { ninety_days:  583,</span>
<span style=color:#75715e>#         thirty_days:  392,</span>
<span style=color:#75715e>#         fifteen_days: 83 }</span>
</code></pre></div><p>Yay! We got the same result and look at how little code it is! If you’re querying a big dataset, this will save to all kinds of time!</p>
<h2 id=wrapping-up>Wrapping Up</h2>
<p>If you need to retrieve data from the database, but don&rsquo;t need any of the functionality of your models, use <code>exec_query</code> to skip ActiveRecord and speed things up a bit.</p>
<p>If you <em>do</em> need ActiveRecord, then you can add additional attributes to the object you get back by passing SQL into the <code>select</code> method and naming giving it a name with <code>AS</code>.</p>
<p>For queries that have complex joins, or ones that you might need to build programmatically, relying on ActiveRecord might get difficult. Take a look at <a href=https://github.com/rails/arel>Arel</a>, a library that forms the abstract syntax tree manager behind ActiveRecord, for situations like this.</p>
</div>
<div class=pagination>
<a href=/blog/2018-03-22-rewrite-git-history/ class="left arrow">&#8592;</a>
<a href=/blog/2018/05/26/concatenating-mysql-results-with-group-by/ class="right arrow">&#8594;</a>
<a href=# class=top>Top</a>
</div>
</main>
<footer>
<span>
&copy; <time datetime="2022-02-26 17:04:08.978804286 +0000 UTC m=+0.107549867">2022</time> Cassidy Scheffer. Made with <a href=https://gohugo.io>Hugo</a> using the <a href=https://github.com/EmielH/tale-hugo/>Tale</a> theme.
</span>
</footer>
</body>
</html>