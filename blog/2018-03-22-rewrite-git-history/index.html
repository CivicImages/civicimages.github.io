<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>How to Rewrite git History when Collaborating with Others &#183; Cassidy Scheffer</title>
<link rel=stylesheet href=/css/style.css>
<link rel=stylesheet href=/css/fonts.css>
<link rel=icon href=favicon.ico>
<link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16.png>
<link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png>
<link href rel=alternate type=application/rss+xml title="Cassidy Scheffer">
</head>
<body>
<nav class=nav>
<div class=nav-container>
<a href=/>
<h2 class=nav-title>Cassidy Scheffer</h2>
</a>
<ul>
<li>
<a href=/blog/>
<span>Posts</span>
</a>
</li>
<li>
<a href=https://github.com/cassidycodes>
<span>GitHub</span>
</a>
</li>
<li>
<a href=https://www.linkedin.com/in/cassidyscheffer/>
<span>LinkedIn</span>
</a>
</li>
</ul>
</div>
</nav>
<main>
<div class=post>
<div class=post-info>
<span>Written by</span>
Cassidy Scheffer
<br>
<span>on&nbsp;</span><time datetime="2018-03-22 00:00:00 +0000 UTC">March 22, 2018</time>
</div>
<h1 class=post-title>How to Rewrite git History when Collaborating with Others</h1>
<div class=post-line></div>
<p>I was recently working on a new node project, and while I was first testing things out, I committed the contents of the dist directory to git. Later on, I was getting the project set up with Docker, and I realized I didn’t want the dist in the repo as it would increase the size of the Docker image.</p>
<p>Removing files from git is a bit tricky. You can add it to the .gitignore, but once git is tracking an object, git will always follow its changes even if it&rsquo;s in the gitignore. I&rsquo;ve kept <a href=https://dalibornasevic.com/posts/2-permanently-remove-files-and-folders-from-a-git-repository>Dalibor Nasevic&rsquo;s post</a> in my bookmarks for situations like this. But to remove the dist from our project, we needed to rewrite history on multiple branches to be sure that the files here would never show up again</p>
<p>Here are the steps we followed to rewrite history on multiple branches:</p>
<p>Checkout master.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git checkout master
</code></pre></div><p>Add <code>dist/</code> to the <code>.gitignore</code>.</p>
<p>Rewrite history on master to ignore the <code>dist</code> directory. Note that this rewrites the SHA of each commit. Your branch will now look like an entirely different set of commits to git.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git filter-branch --tree-filter <span style=color:#e6db74>&#39;rm -rf dist&#39;</span> HEAD
</code></pre></div><p>See if any objects in your repo are pointing to the dist. You should see your branch name in the output here.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git <span style=color:#66d9ef>for</span>-each-ref --format<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;delete %(refname)&#39;</span> refs/original
</code></pre></div><p>Dereference the objects by expiring the reflog and forcing GC.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git <span style=color:#66d9ef>for</span>-each-ref --format<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;delete %(refname)&#39;</span> refs/original | git update-ref --stdin
git reflog expire --expire<span style=color:#f92672>=</span>now --all
git gc --prune<span style=color:#f92672>=</span>now
</code></pre></div><p>Force push the new master branch.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git push origin master --force
</code></pre></div><p>Now other developers will need to follow similar steps to get their branches up to date. They can checkout their working branch and follow steps above, but stop short of pushing their branches. These steps will remove the <code>dist</code> directory from history for them, but they will rewrite every SHA in the branch&rsquo;s history, so the new master branch and their branch will look different to git. To fix this, we&rsquo;ll cherry pick their commits onto a new branch.</p>
<p>Use this command to find the range of SHAs you want to cherrypick. If you have more than 50 commits in your branch, you can drop the <code>-n 50</code> option. Copy the first and last SHAs of your work.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git log —pretty<span style=color:#f92672>=</span>oneline —graph —abbrev-commit -n <span style=color:#ae81ff>50</span>
</code></pre></div><p>Start with the new history</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git checkout master
</code></pre></div><p>And branch off of that</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git checkout -b your-branch-new-history
</code></pre></div><p>And finally cherry-pick your commits onto your new branch</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git cherry-pick &lt;starting sha&gt;..&lt;ending sha&gt;
</code></pre></div><p>You can now remove your original working branch and push your new work up to GitHub. Once you&rsquo;ve fixed all your working branches, you can verify that the <code>dist</code> directory is no longer in your history by listing all files ever tracked by git, including deleted ones:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git log --pretty<span style=color:#f92672>=</span>format: --name-only --diff-filter<span style=color:#f92672>=</span>A | sort - | sed <span style=color:#e6db74>&#39;/^$/d&#39;</span> | grep dist
</code></pre></div>
</div>
<div class=pagination>
<a href=/blog/2017/05/12-toronto-sound-prints/ class="left arrow">&#8592;</a>
<a href=/blog/2018/04/12/return-raw-data-from-active-record/ class="right arrow">&#8594;</a>
<a href=# class=top>Top</a>
</div>
</main>
<footer>
<span>
&copy; <time datetime="2022-02-26 17:06:33.416857821 +0000 UTC m=+0.087048944">2022</time> Cassidy Scheffer. Made with <a href=https://gohugo.io>Hugo</a> using the <a href=https://github.com/EmielH/tale-hugo/>Tale</a> theme.
</span>
</footer>
</body>
</html>